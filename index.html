<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM Career Catalyst</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for chat bubbles */
        .chat-bubble {
            max-width: 75%;
            padding: 12px 20px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word; /* Ensure long words wrap */
        }
        .chat-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .chat-bot {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        /* Style for markdown content */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.25rem; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-content ol { list-style-type: decimal; margin-left: 1.5rem; }
        .markdown-content p { margin-bottom: 0.5rem; }
        .markdown-content strong { font-weight: 600; }
        .markdown-content pre {
            background-color: #f3f4f6; /* gray-100 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
            font-family: monospace;
            white-space: pre-wrap; /* Ensure preformatted text wraps */
            word-break: break-all; /* Break long lines */
        }
        .markdown-content code {
             background-color: #f3f4f6; /* gray-100 */
             padding: 0.1em 0.3em;
             border-radius: 0.25rem;
             font-family: monospace;
        }
        .markdown-content pre code {
             background-color: transparent;
             padding: 0;
             border-radius: 0;
        }

    </style>
    <!-- Marked.js for rendering Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar for Inputs -->
        <div class="w-1/3 bg-white p-6 shadow-lg overflow-y-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">ðŸš€ SRM Career Catalyst</h1>

            <!-- Job Description Input -->
            <div class="mb-4">
                <label for="job-description" class="block text-sm font-medium text-gray-700 mb-2">1. Paste Job Description</label>
                <textarea id="job-description" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the full job description here..."></textarea>
            </div>

            <!-- Resume Upload Input -->
            <div class="mb-6">
                <label for="resume-upload" class="block text-sm font-medium text-gray-700 mb-2">2. Upload Your Resume (PDF)</label>
                <input id="resume-upload" type="file" accept=".pdf" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                "/>
            </div>

            <!-- Analyze Button -->
            <button id="analyze-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                <svg id="analyze-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="button-text">Analyze Resume</span>
            </button>

            <!-- Error Message Box -->
            <div id="error-box" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <p id="error-message"></p>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="w-2/3 flex flex-col h-screen">
            <div id="chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-4 bg-gray-50"> <!-- Added bg color -->
                <!-- Chat messages will be appended here -->
                <div class="chat-bubble chat-bot">
                    <p>Hello! I'm ready to analyze your resume. Please paste a job description and upload your PDF, then click "Analyze Resume".</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get all DOM elements
        const analyzeButton = document.getElementById('analyze-button');
        const buttonText = document.getElementById('button-text');
        const analyzeIcon = document.getElementById('analyze-icon');
        const loadingSpinner = document.getElementById('loading-spinner');

        const jobDescriptionInput = document.getElementById('job-description');
        const resumeUploadInput = document.getElementById('resume-upload');

        const chatWindow = document.getElementById('chat-window');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        // --- Helper: Display Messages ---
        function addMessage(sender, text, isHtml = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender === 'user' ? 'chat-user' : 'chat-bot'}`;
            const content = document.createElement('div'); // Always use a content div
            content.className = 'markdown-content'; // Apply class for potential markdown

            if (isHtml) {
                 try {
                     content.innerHTML = marked.parse(text);
                 } catch (e) {
                     console.error("Markdown parsing error:", e);
                     content.textContent = text; // Fallback to plain text
                 }
            } else {
                content.textContent = text;
            }

            bubble.appendChild(content);
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to bottom
            return content; // Return the content element for streaming updates
        }

        // --- Helper: Toggle Loading State ---
        function setLoading(isLoading) {
            if (isLoading) {
                buttonText.textContent = 'Analyzing...';
                analyzeIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                analyzeButton.disabled = true;
            } else {
                buttonText.textContent = 'Analyze Resume';
                analyzeIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        // --- Helper: Show/Hide Errors ---
        async function showError(errorData) {
            let message = "An unknown error occurred.";
            if (errorData instanceof TypeError && (errorData.message.includes('NetworkError') || errorData.message.includes('Failed to fetch'))) {
                message = "Network error: Could not connect to the backend server. Is it running at http://127.0.0.1:8000?";
            }
            else if (typeof errorData === 'string') {
                message = errorData;
            } else if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                    message = errorData.detail.map(err => `${err.loc.join('->')}: ${err.msg}`).join('; ');
                } else if (typeof errorData.detail === 'string') {
                    message = errorData.detail;
                }
            } else if (errorData.message) {
                message = errorData.message;
            } else {
                 try { message = JSON.stringify(errorData); } catch (e) { /* leave as unknown */ }
            }

            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            // Add error as plain text, not HTML
            addMessage('bot', `Sorry, an error occurred: ${message}`, false);
        }
        function hideError() {
            errorBox.classList.add('hidden');
        }

        // --- Main Event Listener for the Analyze Button ---
        analyzeButton.addEventListener('click', async () => {
            hideError();

            const jobDescription = jobDescriptionInput.value;
            const resumeFile = resumeUploadInput.files[0];

            if (!jobDescription || !resumeFile) {
                showError('Please provide both a job description and a resume file.');
                return;
            }
            if (resumeFile.type !== 'application/pdf') {
                showError('Please upload a PDF file.');
                return;
            }

            setLoading(true);
            addMessage('user', `Please analyze my resume (${resumeFile.name}) for this job description.`);

            const formData = new FormData();
            formData.append('resume_file', resumeFile);

            // Create the initial bot bubble with a placeholder
            const botContentElement = addMessage('bot', 'Analyzing...');

            let fullResponse = "";

            try {
                const url = new URL('http://127.0.0.1:8000/analyze');
                url.searchParams.append('job_description', jobDescription);

                const response = await fetch(url, { method: 'POST', body: formData });

                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); }
                    catch (e) { errorData = { message: `Server error: ${response.status} ${response.statusText}` }; }
                    throw errorData;
                }

                // Handle the response stream
                const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
                botContentElement.textContent = ''; // Clear placeholder

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    fullResponse += value;
                    // --- ** THE FIX: Update plain text content during stream ** ---
                    botContentElement.textContent = fullResponse + "..."; // Show plain text + indicator
                    // --- ** END FIX ** ---
                    chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll as content grows
                }

                // --- ** THE FIX: Parse Markdown only ONCE after stream ends ** ---
                try {
                     botContentElement.innerHTML = marked.parse(fullResponse); // Render final HTML
                } catch (e) {
                     console.error("Final markdown parsing error:", e);
                     botContentElement.textContent = fullResponse; // Fallback to plain text if parse fails
                     showError(`Markdown parsing failed: ${e.message}`); // Show error to user
                }
                // --- ** END FIX ** ---
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll again after final render

            } catch (err) {
                console.error('Fetch error / Server error:', err);
                showError(err);
                 if (botContentElement && botContentElement.parentNode && botContentElement.parentNode.parentNode === chatWindow) {
                     try { chatWindow.removeChild(botContentElement.parentNode); } catch (e) { /* Ignore */ }
                 }
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>
</html>

